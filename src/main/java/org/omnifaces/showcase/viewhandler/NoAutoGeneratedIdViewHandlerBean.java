package org.omnifaces.showcase.viewhandler;

import static org.omnifaces.util.Faces.getInitParameter;

import java.io.IOException;

import jakarta.enterprise.context.RequestScoped;
import jakarta.faces.FacesException;
import jakarta.faces.context.ExternalContext;
import jakarta.faces.context.FacesContext;
import jakarta.faces.event.PhaseId;
import jakarta.inject.Named;

import org.omnifaces.util.Events;
import org.omnifaces.viewhandler.NoAutoGeneratedIdViewHandler;
import org.omnifaces.viewhandler.NoAutoGeneratedIdViewHandler.NoAutoGeneratedIdResponseWriter;

@Named
@RequestScoped
public class NoAutoGeneratedIdViewHandlerBean {

	/**
	 * Normally, the {@link NoAutoGeneratedIdViewHandler} is supposed to be installed as <view-handler> in
	 * faces-config.xml. However, as this affects the entire site and we'd like to keep the showcase examples as
	 * simple as possible (without forcing to specify ID boilerplate everytime), here's a different way of installing
	 * it on only a per-request basis.
	 *
	 * This is NOT the recommended approach. This is just done so for demo purposes.
	 */
	public void installResponseWriter() {
		Events.subscribeToRequestBeforePhase(PhaseId.RENDER_RESPONSE, event -> {
			FacesContext context = event.getFacesContext();
			ExternalContext ec = context.getExternalContext();
			ec.setResponseBufferSize(Integer.valueOf(getInitParameter("jakarta.faces.FACELETS_BUFFER_SIZE")));
			ec.setResponseContentType("text/html");
			ec.setResponseCharacterEncoding("UTF-8");

			try {
				context.setResponseWriter(new NoAutoGeneratedIdResponseWriter(
					context.getRenderKit().createResponseWriter(
						ec.getResponseOutputWriter(),
						ec.getResponseContentType(),
						ec.getResponseCharacterEncoding())));
			}
			catch (IOException e) {
				throw new FacesException(e);
			}
		});
	}

}